!function(o){"use strict";const e=abslayer.BrowserUtil.isFirefox,t=abslayer.Helpers.isHandheld();const n="abslayerWalletInfo",c={supportedWallets:{subwallet:{name:"SubWallet",type:"substrate",provider:"subwallet-js",logo:"",getInstallUrl:function(){return t?"https://mobile.subwallet.app/?url=https%3A%2F%2Fdotinsights.subwallet.app%2F":e?"https://mzl.la/3rQ0awW":"https://subwallet.app/download.html"}},"subwallet-evm":{name:"SubWallet - EVM",type:"evm",provider:"SubWallet",evmDetect:"isSubWallet",logo:"",getInstallUrl:function(){return t?"https://mobile.subwallet.app/?url=https%3A%2F%2Fdotinsights.subwallet.app%2F":e?"https://mzl.la/3rQ0awW":"https://subwallet.app/download.html"}},talisman:{name:"Talisman",type:"substrate",provider:"talisman",logo:"",getInstallUrl:function(){return"https://talisman.xyz/download"}},"talisman-evm":{name:"Talisman - EVM",type:"evm",provider:"talismanEth",evmDetect:"isTalisman",logo:"",getInstallUrl:function(){return"https://talisman.xyz/download"}},polkadot:{name:"Polkadot{.js}",type:"substrate",provider:"polkadot-js",logo:"",getInstallUrl:function(){return"https://polkadot.js.org/extension/"}},metamask:{name:"MetaMask",type:"evm",provider:"ethereum",evmDetect:"isMetaMask",logo:"",getInstallUrl:function(){return"https://metamask.io/download/"}}},currentWallet:null,currentWalletName:null,currentWalletType:"none",currentAddress:null,currentVoteAbility:!1,getSavedState:function(){var e=JSON.parse(localStorage.getItem(n))||{};return{currentWalletName:e.currentWalletName,currentAddress:e.currentAddress,currentSignMessage:e.currentSignMessage,currentVoteAbility:e.currentVoteAbility}},saveState:function(e){var t=c.getSavedState();e.hasOwnProperty("currentWalletName")&&(c.currentWalletName=e.currentWalletName,t.currentWalletName=e.currentWalletName),e.hasOwnProperty("currentAddress")&&(c.currentAddress=e.currentAddress,t.currentAddress=e.currentAddress),e.hasOwnProperty("currentSignMessage")&&(c.currentSignMessage=e.currentSignMessage,t.currentSignMessage=e.currentSignMessage),e.hasOwnProperty("currentVoteAbility")&&(c.currentVoteAbility=e.currentVoteAbility,t.currentVoteAbility=e.currentVoteAbility),localStorage.setItem(n,JSON.stringify(t))},resetState:function(){c.saveState({currentWalletName:null,currentAddress:null,currentSignMessage:void 0,currentVoteAbility:!1})},loadSavedState:function(){var e=c.getSavedState();Object.assign(c,e)},getCurrentWallet:async function(){if(c.loadSavedState(),c.currentWalletName&&c.currentAddress)return c.enableWallet(c.currentWalletName)},isInstall:function(e){return!!c.getWallet(e)},isConnectedWithWallet:async function(){return!!await abslayer.walletUtils.getCurrentWallet()},getWallet:function(e){e=c.supportedWallets[e];if(e)return"evm"!==e.type?window.injectedWeb3&&window.injectedWeb3[e.provider]:window[e.provider]&&window[e.provider][e.evmDetect]?window[e.provider]:void 0},enableWallet:async function(n){const a=c.supportedWallets[n];if(!a)throw new Error("Wallet is not support");const r=c.getWallet(n);if(!r)throw new Error("Wallet is not install");return new Promise(function(t,e){!async function(){return"evm"===a.type?r.request({method:"eth_requestAccounts"}):r.enable()}().then(async e=>{c.currentWalletType=a.type,"evm"===a.type?c.currentWallet=r:c.currentWallet=e,c.currentWalletName!==n&&c.saveState({currentWalletName:n,currentAddress:void 0,currentSignMessage:void 0,currentVoteAbility:!1});e=await c.getAccounts();e.map(e=>e.address).indexOf(c.currentAddress)<0&&e[0]&&e[0].address&&(c.enableAccount(e[0].address),c.saveState({currentAddress:e[0].address})),t(c.currentWallet)}).catch(()=>{m("<p>Unable to connect.<br />User rejects wallet connection.</p>"),e(new Error("User cancel or reject connect to the wallet"))})})},getAccounts:async function(){return c.currentWallet||await c.getCurrentWallet(),"evm"===c.currentWalletType?(await c.currentWallet.request({method:"eth_accounts"})).map(e=>({address:e,name:e})):c.currentWallet.accounts.get()},enableAccount:function(e){c.currentAddress!==e&&c.saveState({currentAddress:e,currentSignMessage:void 0,currentVoteAbility:!1})},getSignMessage:async function(e){e=(await abslayer.requestUtils.sendPost(abslayer.Helpers.getApiEndpointUrl("getMessage"),{address:e})).message;c.saveState({currentSignMessage:e,currentVoteAbility:!0})},signMessage:async function(e){if(c.currentWallet||c.currentAddress)return"evm"===c.currentWalletType?c.currentWallet.request({method:"personal_sign",params:[e,c.currentAddress]}):c.currentWallet.signer.signRaw({address:c.currentAddress,data:e});throw new Error("Unable get current wallet or current account to sign message")},signVote:async function(e){try{if(c.currentWallet||await c.getCurrentWallet(),c.currentSignMessage&&c.currentVoteAbility||await c.getSignMessage(c.currentAddress),!c.currentVoteAbility)throw new Error("Unable to vote, required has balance on at least one chain in ecosystem");var t=await c.signMessage(c.currentSignMessage+"-"+e),n="object"==typeof t?t.signature:t;if("string"!=typeof n)throw new Error("Invalid signature");return n}catch(e){return console.error(e),!1}},runTestOnLoadPage(){setTimeout(async function(){c.loadSavedState();try{await c.isConnectedWithWallet()?(console.log("Enable existed wallet"),await c.enableWallet(c.currentWalletName),await c.getAccounts(),await c.currentAddress):console.log("Not connect with wallet")}catch(e){console.error("Connect wallet error: "+e.message)}},500)},runTestSelectWallet:function(){c.supportedWallets,Object.entries(c.supportedWallets).forEach(function([e,t]){console.log(t.name,c.isInstall(e)),console.log(t.name,e===c.currentWalletName)});c.enable("subwallet")},runTestSelectAccount:async function(){var e=await c.getAccounts();c.enableAccount(e[0].address)},runTestVoteProject:async function(){var e=await c.signVote("ProjectID");console.log(e)}};window.abslayer=window.abslayer||{},abslayer.walletUtils=c,abslayer.VotedProjects=[];var a=abslayer.Helpers,i=o("#modal-connect-wallet"),r=o("#modal-show-error"),l=o("#modal-show-info"),u=i.find(".modal-content-body");function s(){setTimeout(async function(){c.loadSavedState();try{(await c.isConnectedWithWallet()?(await c.enableWallet(c.currentWalletName),"evm"===c.currentWalletType&&c.currentWallet.on("accountsChanged",e=>{(1===e.length||1<e.length&&!e.includes(c.currentAddress))&&c.enableAccount(e[0]),p()}),p):d)()}catch(e){console.error("Connect wallet error: "+e.message),d()}},500)}function d(){var e,t="";for(e in c.supportedWallets){var n=c.supportedWallets[e],a=c.isInstall(e),r="button button--wallet wallet--"+e;t+=`<a data-wallet="${e}" href="${a?"#":n.getInstallUrl()}" class="${r+=a?" btn-connect-wallet":" button-right-icon btn-install-wallet"}" ${a?"":' target="_blank"'}><span class="button-text">${n.name}</span>${a?"":'<span class="button-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.0625 10.3135L12 14.2499L15.9375 10.3135" stroke="#66E1B6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 3.75V14.2472" stroke="#66E1B6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M20.25 14.25V19.5C20.25 19.6989 20.171 19.8897 20.0303 20.0303C19.8897 20.171 19.6989 20.25 19.5 20.25H4.5C4.30109 20.25 4.11032 20.171 3.96967 20.0303C3.82902 19.8897 3.75 19.6989 3.75 19.5V14.25" stroke="#66E1B6" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></span>'}</a>`}o(".btn-open-connect-wallet").find(".button-text span").text("Connect Wallet"),u.empty().html(t),i.find(".modal-title").text("Connect Your Wallet")}async function p(){for(var e=await c.getAccounts(),t=await c.currentAddress,n=null,a="",r=0;r<e.length;r++){var l=e[r],s="wallet-account-address";l.address===t&&(s+=" selected-account",n=l),a+=`<div class="${s}" data-address="${l.address}">
								<div class="wallet-icon"></div>
                                <div id="wallet-info">
                                    <div class="wallet-name text-1-row"><span>${l.name}</span></div>
                                    <div class="wallet-address text-1-row"><span>${l.address}</span></div>
                                </div>
							</div>`}a+='<div class="button-wrap btn-disconnect-wallet-wrap"><a href="#" class="button btn-disconnect-wallet"><span class="button-text">Disconnect</span></a></div>',o(".btn-open-connect-wallet").find(".button-text span").text(n.name),i.find(".modal-title").text("Choose account"),u.empty().html(a),g(t)}function g(e){o.ajax({method:"POST",url:a.getApiEndpointUrl("getVotedProject"),data:{address:e},success:function(e){abslayer.VotedProjects=e,o(document.body).trigger("abslayer/VotedProjects/Refreshed")}})}function m(e){r.find(".modal-error-message").html(e),r.abslayerModal("open")}i.abslayerModal(),o(document).ready(function(){o(document.body).on("click",".btn-connect-wallet",function(e){e.preventDefault();var t=o(this);a.setElementHandling(t),setTimeout(async function(){var e=t.data("wallet");try{await c.enableWallet(e),s()}catch(e){console.error(e),a.unsetElementHandling(t)}},500)}),o(document.body).on("click",".btn-disconnect-wallet",function(e){e.preventDefault();e=o(this);a.setElementHandling(e),setTimeout(function(){c.resetState(),s()},500)}),o(document.body).on("click",".btn-vote",function(e){e.preventDefault(),e.stopPropagation(),l.find(".modal-message").html("<p>Voting coming soon!</p>"),l.abslayerModal("open")}),o(document.body).on("click",".wallet-account-address",function(e){e.preventDefault(),e.stopPropagation(),o(this).hasClass("selected-account")||async function(e){var t=await c.getAccounts();for(var n=e.data("address"),a=0;a<t.length;a++)if(n===t[a].address){c.enableAccount(n),e.siblings().removeClass("selected-account"),e.addClass("selected-account"),o(".btn-open-connect-wallet").find(".button-text span").text(t[a].name),g(n),i.abslayerModal("close");break}}(o(this))}),s()}),o(document.body).on("abslayer/VotedProjects/Refreshed",function(){if(o(".btn-vote").addClass("vote-this").removeClass("unvote-this"),0<abslayer.VotedProjects.length)for(var e=0;e<abslayer.VotedProjects.length;e++)o('.btn-vote[data-project-id="'+abslayer.VotedProjects[e]+'"]').removeClass("vote-this").addClass("unvote-this")})}(jQuery);